<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>兒童／新生兒給藥換算器｜Pediatric Dose Calculator</title>
    <meta name="description" content="以 mg/kg × kg ÷ (mg/mL) 計算需抽 mL 與至少需要幾支藥。適用於兒童與新生兒劑量換算。" />
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>💉</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="min-h-screen bg-gradient-to-b from-white to-slate-50 text-slate-900">
    <a class="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 bg-white px-3 py-2 rounded-md border" href="#main">跳至主要內容</a>
    <div id="root"></div>

    <script type="text/babel" data-presets="react,env">
      const { useMemo, useState } = React;

      // utils
      const roundN = (val, n) => {
        if (!Number.isFinite(val)) return 0;
        const f = Math.pow(10, n);
        return Math.round(val * f) / f;
      };
      const safeNum = (v) => (Number.isFinite(v) && v >= 0 ? v : 0);
      const numOrZero = (s) => {
        if (s === "" || s === null || s === undefined) return 0;
        const n = Number(s);
        return Number.isFinite(n) ? n : 0;
      };

      // Stat card（支援紅字/米色底與加大數值）
      function Stat({ label, value, mono, highlight = false, labelClass = "", bgClass = "bg-white" }) {
        const valueClass =
          (highlight ? "text-red-600 font-extrabold text-3xl md:text-4xl " : "text-lg font-semibold ") +
          (mono ? "font-mono " : "");
        return (
          <div className={`rounded-xl border border-slate-200 p-3 ${bgClass}`}>
            <div className={`text-xs ${labelClass || "text-slate-500"}`}>{label}</div>
            <div className={valueClass}>{value}</div>
          </div>
        );
      }

      function App() {
        // 預設值：0.01 mg/kg、30 kg、每支總量 1 mg、每支 1 mL → 等效濃度 1 mg/mL
        const [doseMgPerKg, setDoseMgPerKg] = useState(0.01);
        const [weightKg, setWeightKg] = useState(30);
        const [totalMgPerVial, setTotalMgPerVial] = useState(1); // ← 改為「每支總量 (mg/支)」
        const [vialVolumeMl, setVialVolumeMl] = useState(1);     // 每支容量 (mL/支)
        const [decimals, setDecimals] = useState(2);

        const data = useMemo(() => {
          const d = safeNum(doseMgPerKg);
          const w = safeNum(weightKg);
          const mgPerVial = safeNum(totalMgPerVial);
          const vv = safeNum(vialVolumeMl);

          const totalMg = d * w; // mg
          const concMgPerMl = vv > 0 ? mgPerVial / vv : 0; // 等效濃度 mg/mL
          const totalMl = concMgPerMl > 0 ? totalMg / concMgPerMl : 0; // mL

          const vialsExact = vv > 0 ? totalMl / vv : 0;
          const vialsCeil = Math.ceil(vialsExact > 0 ? vialsExact : 0);
          const wholeVials = vv > 0 ? Math.floor(totalMl / vv) : 0;
          let remainderMl = totalMl - wholeVials * vv;
          if (remainderMl < 1e-9) remainderMl = 0;

          return { totalMg, totalMl, concMgPerMl, mgPerVial, vialsExact, vialsCeil, wholeVials, remainderMl };
        }, [doseMgPerKg, weightKg, totalMgPerVial, vialVolumeMl]);

        const onNum = (setter) => (e) => setter(numOrZero(e.target.value));

        return (
          <main id="main" className="mx-auto max-w-4xl px-4 py-8">
            <header className="mb-6">
              <h1 className="text-2xl md:text-3xl font-bold tracking-tight">兒童／新生兒給藥換算器</h1>
              <p className="text-sm md:text-base text-slate-600 mt-1">
                體積(mL) = <span className="font-mono">[劑量(mg/kg) × 體重(kg)] ÷ 等效濃度(mg/mL)</span>，
                等效濃度 = <span className="font-mono">每支總量(mg) ÷ 每支容量(mL)</span>。
              </p>
            </header>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {/* Inputs */}
              <section aria-labelledby="inputs" className="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
                <h2 id="inputs" className="text-lg font-semibold mb-4">輸入參數</h2>
                <div className="space-y-4">
                  <div className="grid grid-cols-5 items-end gap-2">
                    <label className="col-span-3 text-sm text-slate-700">劑量 Dose</label>
                    <input
                      type="number" inputMode="decimal" step="0.001" min="0" aria-label="劑量 mg/kg"
                      value={doseMgPerKg} onChange={onNum(setDoseMgPerKg)}
                      className="col-span-3 md:col-span-2 w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-400"
                      placeholder="例如 0.01"
                    />
                    <div className="col-span-2 md:col-span-3 text-sm text-slate-500">mg/kg</div>
                  </div>

                  <div className="grid grid-cols-5 items-end gap-2">
                    <label className="col-span-3 text-sm text-slate-700">體重 Weight</label>
                    <input
                      type="number" inputMode="decimal" step="0.1" min="0" aria-label="體重 kg"
                      value={weightKg} onChange={onNum(setWeightKg)}
                      className="col-span-3 md:col-span-2 w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-400"
                      placeholder="例如 30"
                    />
                    <div className="col-span-2 md:col-span-3 text-sm text-slate-500">kg</div>
                  </div>

                  <div className="grid grid-cols-5 items-end gap-2">
                    <label className="col-span-3 text-sm text-slate-700">
                      每支總量 Total drug per vial
                    </label>
                    <input
                      type="number" inputMode="decimal" step="0.01" min="0" aria-label="每支總量 mg/支"
                      value={totalMgPerVial} onChange={onNum(setTotalMgPerVial)}
                      className="col-span-3 md:col-span-2 w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-400"
                      placeholder="例如 150（表示 150 mg/支）"
                    />
                    <div className="col-span-2 md:col-span-3 text-sm text-slate-500">mg/支</div>
                  </div>

                  <div className="grid grid-cols-5 items-end gap-2">
                    <label className="col-span-3 text-sm text-slate-700">每支容量 Vial volume</label>
                    <input
                      type="number" inputMode="decimal" step="0.01" min="0" aria-label="每支容量 mL/支"
                      value={vialVolumeMl} onChange={onNum(setVialVolumeMl)}
                      className="col-span-3 md:col-span-2 w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-400"
                      placeholder="例如 3（表示 3 mL/支）"
                    />
                    <div className="col-span-2 md:col-span-3 text-sm text-slate-500">mL/支</div>
                  </div>

                  <div className="grid grid-cols-5 items-end gap-2">
                    <label className="col-span-3 text-sm text-slate-700">顯示小數位數</label>
                    <input
                      type="number" step="1" min="0" max="4" aria-label="顯示小數位數"
                      value={decimals} onChange={onNum(setDecimals)}
                      className="col-span-3 md:col-span-2 w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-400"
                    />
                    <div className="col-span-2 md:col-span-3 text-sm text-slate-500">位</div>
                  </div>

                  <div className="flex gap-2 pt-2">
                    <button
                      onClick={() => { setDoseMgPerKg(0.01); setWeightKg(30); setTotalMgPerVial(1); setVialVolumeMl(1); setDecimals(2); }}
                      className="rounded-xl bg-slate-900 px-4 py-2 text-white shadow hover:bg-slate-800"
                    >
                      套用範例（0.01 mg/kg，30 kg，150 mg/3 mL 例：請改填 1 mg/1 mL → 1 與 1）
                    </button>
                    <button
                      onClick={() => { setDoseMgPerKg(0); setWeightKg(0); setTotalMgPerVial(0); setVialVolumeMl(0); }}
                      className="rounded-xl border border-slate-300 bg-white px-4 py-2 text-slate-700 shadow-sm hover:bg-slate-50"
                    >
                      清空
                    </button>
                  </div>
                </div>
              </section>

              {/* Results */}
              <section aria-labelledby="results" className="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
                <h2 id="results" className="text-lg font-semibold mb-4">結果</h2>

                <div className="space-y-3 text-sm">
                  <div className="rounded-xl bg-slate-50 p-3">
                    <div className="font-medium">計算公式</div>
                    <div className="text-slate-700 mt-1 leading-relaxed">
                      體積(mL) ＝ <span className="font-mono">[劑量(mg/kg) × 體重(kg)] ÷ 等效濃度(mg/mL)</span>
                    </div>
                    <div className="text-slate-700 mt-1 leading-relaxed">
                      等效濃度(mg/mL) ＝ <span className="font-mono">每支總量(mg) ÷ 每支容量(mL)</span>
                      {' '}= <span className="font-mono">{roundN(data.concMgPerMl, decimals).toFixed(decimals)} mg/mL</span>
                    </div>
                  </div>

                  <!-- 重新排序：第一列＝開幾支、需抽體積（紅字標籤＋米色底＋大紅粗數值） -->
                  <div className="grid grid-cols-2 gap-3">
                    <Stat
                      label="至少需要開幾支"
                      value={data.vialsCeil}
                      highlight
                      labelClass="text-red-700"
                      bgClass="bg-amber-50"
                    />
                    <Stat
                      label="需抽體積 (mL)"
                      value={roundN(data.totalMl, decimals).toFixed(decimals)}
                      mono
                      highlight
                      labelClass="text-red-700"
                      bgClass="bg-amber-50"
                    />

                    <!-- 第二列：其餘維持原樣 -->
                    <Stat
                      label="總劑量 (mg)"
                      value={roundN(data.totalMg, decimals).toFixed(decimals)}
                      mono
                    />
                    <Stat
                      label="每支總含量 (mg)"
                      value={roundN(data.mgPerVial, decimals).toFixed(decimals)}
                      mono
                    />
                  </div>

                  <hr className="border-slate-200 my-2" />

                  <div>
                    <div className="font-medium mb-1">抽藥建議</div>
                    {data.vialsCeil === 0 ? (
                      <p className="text-slate-600">—</p>
                    ) : (
                      <ol className="list-decimal pl-5 space-y-1 text-slate-700">
                        {Array.from({ length: data.wholeVials }).map((_, i) => (
                          <li key={i}>第 {i + 1} 支：抽 {roundN(vialVolumeMl, decimals).toFixed(decimals)} mL</li>
                        ))}
                        {data.remainderMl > 0 && (
                          <li>第 {data.vialsCeil} 支：抽 {roundN(data.remainderMl, decimals).toFixed(decimals)} mL</li>
                        )}
                      </ol>
                    )}
                    {data.vialsCeil > 0 && (
                      <p className="mt-2 text-xs text-slate-500">
                        ※ 以上以向上取整計算至少需要開 {data.vialsCeil} 支，實際抽取體積合計為 {roundN(data.totalMl, decimals).toFixed(decimals)} mL（{roundN(data.totalMg, decimals).toFixed(decimals)} mg）。
                      </p>
                    )}
                  </div>

                  {(totalMgPerVial === 0 || vialVolumeMl === 0) && (
                    <div className="rounded-xl bg-amber-50 border border-amber-200 p-3 text-amber-800 text-xs">
                      請輸入有效的「每支總量 (mg/支)」與「每支容量 (mL/支)」以完成計算。
                    </div>
                  )}

                  <div className="rounded-xl bg-slate-50 p-3 text-xs text-slate-600">
                    <div className="font-medium mb-1">安全提醒</div>
                    <ul className="list-disc pl-5 space-y-1">
                      <li>再次核對單次與 24 小時內最大允許劑量。</li>
                      <li>確認標示單位無誤（mg、mL、kg）。</li>
                      <li>小數位數為顯示格式；實際抽藥請依注射器刻度與院內規範（常以 0.01 mL 為最小刻度）。</li>
                    </ul>
                  </div>
                </div>
              </section>
            </div>

            <footer className="mt-6 text-xs text-slate-500">
              © 2025 — 僅供教學與輔助計算；臨床處置請依醫囑與院內規範雙人查核。
            </footer>
          </main>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
